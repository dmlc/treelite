trigger:
- master

jobs:
- job: formatting_check
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - checkout: self
  - script: python -m pip install -v --upgrade pip cpplint pylint numpy scipy scikit-learn pytest
    displayName: 'Installing pylint and cpplint...'
  - script: make lint
    displayName: 'Running pylint and cpplint...'
- job: linux_build
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
  - script: tests/ci_build/ci_build.sh cpu tests/ci_build/build_via_cmake.sh -DENABLE_PROTOBUF=ON
    displayName: 'Building Treelite...'
  - script: |
      tests/ci_build/ci_build.sh cpu bash -c "cd python/ && python setup.py bdist_wheel --universal"
    displayName: 'Packaging Python wheel for Treelite...'
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'python_linux_whl'
      targetPath: 'python/dist/'
  - script: |
      tests/ci_build/ci_build.sh cpu bash -c "cd runtime/python/ && python setup.py bdist_wheel --universal"
    displayName: 'Packaging Python wheel for Treelite runtime...'
  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'runtime_python_linux_whl'
      targetPath: 'runtime/python/dist/'
- job: win_build
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - checkout: self
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: 'Add conda to PATH'
  - script: |
      call activate
      conda install numpy scipy scikit-learn pandas
    displayName: 'Setting up Python environment...'
  - script: |
      mkdir build
      cd build
      cmake .. -G"Visual Studio 15 2017 Win64" -DENABLE_PROTOBUF=ON
    displayName: 'Generating Visual Studio solution...'
  - task: MSBuild@1
    inputs:
      solution: 'build/*.sln'
      msbuildArchitecture: 'x64'
      msbuildArguments: '/p:Configuration=Release /m /nodeReuse:false'
    displayName: 'Building Treelite...'
  - script: |
      call activate
      cd python
      python setup.py bdist_wheel --universal
    displayName: 'Packaging Python wheel for Treelite...'
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'python_win_whl'
      targetPath: 'python/dist/'
  - script: |
      call activate
      cd runtime\python
      python setup.py bdist_wheel --universal
    displayName: 'Packaging Python wheel for Treelite runtime...'
  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'runtime_python_win_whl'
      targetPath: 'runtime/python/dist/'
- job: cpp_python_coverage
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - checkout: self
  - script: sudo apt-get install lcov
    displayName: 'Installing lcov...'
  - script: |
      mkdir build/
      cd build/
      cmake .. -DTEST_COVERAGE=ON -DENABLE_PROTOBUF=ON -DCMAKE_BUILD_TYPE=Debug
      make -j$(nproc)
    displayName: 'Building Treelite...'
  - script: python -m pip install -v --upgrade pip numpy scipy pandas pytest pytest-cov scikit-learn xgboost lightgbm
    displayName: 'Setting up Python environment...'
  - script: |
      python -m pytest --cov=treelite --cov=treelite_runtime -v --fulltrace tests/python
      lcov --directory . --capture --output-file coverage.info
      lcov --remove coverage.info '/usr/*' --output-file coverage.info
      lcov --remove coverage.info '*3rdparty*' --output-file coverage.info
      lcov --remove coverage.info '*dmlc-core*' --output-file coverage.info
    displayName: 'Running integration tests...'
    env:
      PYTHONPATH: ./python:./runtime/python
  - script: bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
    displayName: 'Submitting code coverage data to CodeCov...'
    env:
      CODECOV_TOKEN: afe9868c-2c27-4853-89fa-4bc5d3d2b255
- job: win_python_coverage
  pool:
    vmImage: 'windows-latest'
  steps:
  - checkout: self
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: 'Add conda to PATH'
  - script: |
      call activate
      conda install --yes -c conda-forge numpy scipy scikit-learn pandas scikit-learn pytest pytest-cov
    displayName: 'Setting up Python environment...'
  - script: |
      call activate
      python -m pip install -v xgboost lightgbm
    displayName: 'Setting up Python environment...'
  - script: |
      mkdir build
      cd build
      cmake .. -G"Visual Studio 16 2019" -A x64 -DENABLE_PROTOBUF=ON
    displayName: 'Generating Visual Studio solution...'
  - task: MSBuild@1
    inputs:
      solution: 'build/*.sln'
      msbuildArchitecture: 'x64'
      msbuildArguments: '/p:Configuration=Release /m /nodeReuse:false'
    displayName: 'Building Treelite...'
  - script: |
      call activate
      python -m pytest --cov=treelite --cov=treelite_runtime -v --fulltrace tests\python
    displayName: 'Running Python tests...'
    env:
      PYTHONPATH: '$(System.DefaultWorkingDirectory)\python;$(System.DefaultWorkingDirectory)\runtime\python;$(PYTHONPATH)'
  - script: bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
    displayName: 'Submitting code coverage data to CodeCov...'
    env:
      CODECOV_TOKEN: afe9868c-2c27-4853-89fa-4bc5d3d2b255
- job: java_coverage
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - checkout: self
  - script: |
      cd runtime/java/treelite4j
      mvn test -DJNI.args=cpp-coverage
    displayName: 'Running integration tests for Java runtime (treelite4j)...'
  - script: bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
    displayName: 'Submitting Java code (treelite4j) coverage data to CodeCov...'
    env:
      CODECOV_TOKEN: afe9868c-2c27-4853-89fa-4bc5d3d2b255
- job: linux_python_wheel_test
  dependsOn: linux_build
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      addToPath: true
  - checkout: self
  - script: python -m pip install -v --upgrade pip numpy scipy pandas pytest scikit-learn xgboost lightgbm
    displayName: 'Setting up Python environment...'
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'python_linux_whl'
      targetPath: $(System.DefaultWorkingDirectory)
    displayName: 'Downloading Treelite Python wheel for Linux...'
  - task: DownloadPipelineArtifact@1
    inputs:
      artifactName: 'runtime_python_linux_whl'
      targetPath: $(System.DefaultWorkingDirectory)
    displayName: 'Downloading Treelite runtime Python wheel for Linux...'
  - script: |
      python -m pip install *.whl
    displayName: 'Installing Treelite into Python environment...'
  - script: python -m pytest -v --fulltrace tests/python/test_basic.py
    displayName: 'Running Python tests...'
- job: win_python_wheel_test
  dependsOn: win_build
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: 'Add conda to PATH'
  - script: |
      call activate
      conda install --yes -c conda-forge numpy scipy scikit-learn pandas scikit-learn pytest
    displayName: 'Setting up Python environment...'
  - script: |
      call activate
      python -m pip install -v xgboost lightgbm
    displayName: 'Setting up Python environment...'
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'python_win_whl'
      targetPath: $(System.DefaultWorkingDirectory)
    displayName: 'Downloading Treelite Python wheel for Windows...'
  - task: DownloadPipelineArtifact@1
    inputs:
      artifactName: 'runtime_python_win_whl'
      targetPath: $(System.DefaultWorkingDirectory)
    displayName: 'Downloading Treelite runtime Python wheel for Windows...'
  - script: |
      call activate
      for /R %%i in (*.whl) DO python -m pip install "%%i"
    displayName: 'Installing Treelite into Python environment...'
  - script: |
      call activate
      python -m pytest -v --fulltrace tests\python\test_basic.py
    displayName: 'Running Python tests...'
